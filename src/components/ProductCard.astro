---
interface Props {
    product: {
        id: number;
        slug: string;
        name: string;
        category: string;
        description: string;
        price: number;
        discountPrice: number | null;
        image: string;
        badge: string | null;
        inStock: boolean;
    };
}

const { product } = Astro.props;
const hasDiscount =
    product.discountPrice && product.discountPrice < product.price;
const displayPrice = hasDiscount ? product.discountPrice : product.price;
const savingsPercent = hasDiscount
    ? Math.round(
          ((product.price - product.discountPrice!) / product.price) * 100,
      )
    : 0;
---

<div class="card group">
    <!-- Badge -->
    {
        product.badge && (
            <div class="absolute top-4 left-4 z-10">
                <span
                    class={`badge ${
                        product.badge === "Top Rated"
                            ? "badge-green"
                            : product.badge === "Best Seller"
                              ? "badge-gold"
                              : product.badge === "Limited"
                                ? "badge-red"
                                : "badge-purple"
                    }`}
                >
                    {product.badge}
                </span>
            </div>
        )
    }

    <!-- Discount Badge -->
    {
        hasDiscount && (
            <div class="absolute top-4 right-4 z-10">
                <span class="badge badge-red">Save {savingsPercent}%</span>
            </div>
        )
    }

    <!-- Product Image -->
    <a
        href={`/products/${product.slug}`}
        class="block relative aspect-square mb-4 overflow-hidden rounded-lg bg-gradient-burgundy"
    >
        <img
            src={product.image}
            alt={product.name}
            class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
            loading="lazy"
        />
        {
            !product.inStock && (
                <div class="absolute inset-0 bg-black/60 flex items-center justify-center">
                    <span class="text-white font-bold text-lg">
                        Out of Stock
                    </span>
                </div>
            )
        }
    </a>

    <!-- Product Info -->
    <div class="space-y-2">
        <div class="flex items-start justify-between gap-2">
            <div class="flex-1">
                <span
                    class="text-xs text-accent uppercase tracking-wider font-medium"
                >
                    {product.category}
                </span>
                <h3
                    class="font-display font-bold text-xl text-text group-hover:text-accent transition-colors"
                >
                    <a href={`/products/${product.slug}`}>
                        {product.name}
                    </a>
                </h3>
            </div>
        </div>

        <p class="text-text-muted text-sm line-clamp-2">
            {product.description}
        </p>

        <!-- Price & CTA -->
        <div class="flex items-end justify-between pt-2">
            <div class="flex items-baseline gap-2">
                <span class="font-display font-bold text-2xl text-text">
                    ${displayPrice.toFixed(2)}
                </span>
                {
                    hasDiscount && (
                        <span class="text-text-muted line-through text-sm">
                            ${product.price.toFixed(2)}
                        </span>
                    )
                }
            </div>

            {
                product.inStock ? (
                    <button
                        class="btn btn-primary text-sm py-2 px-4"
                        data-product-id={product.id}
                    >
                        Add to Cart
                    </button>
                ) : (
                    <button
                        class="btn btn-ghost text-sm py-2 px-4 opacity-50 cursor-not-allowed"
                        disabled
                    >
                        Sold Out
                    </button>
                )
            }
        </div>
    </div>
</div>

<script>
    // Add to cart functionality
    document.querySelectorAll("[data-product-id]").forEach((button) => {
        button.addEventListener("click", (e) => {
            const productId = (e.target as HTMLElement).dataset.productId;

            // TODO: Implement cart functionality
            console.log("Add to cart:", productId);

            // Visual feedback
            const btn = e.target as HTMLElement;
            const originalText = btn.textContent;
            btn.textContent = "Added!";
            btn.classList.add("bg-gold", "text-primary-dark");

            setTimeout(() => {
                btn.textContent = originalText;
                btn.classList.remove("bg-gold", "text-primary-dark");
            }, 1500);
        });
    });
</script>

<style>
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>
